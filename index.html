<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120354926-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-120354926-1');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Potree Viewer</title>
    <link rel="icon" href="img/logoOSU2.png">
    <link rel="stylesheet" type="text/css" href="libs/potree/potree.css">
    <link rel="stylesheet" type="text/css" href="libs/jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="libs/perfect-scrollbar/css/perfect-scrollbar.css">
    <link rel="stylesheet" type="text/css" href="libs/openlayers3/ol.css">
    <link rel="stylesheet" type="text/css" href="libs/spectrum/spectrum.css">
    <link rel="stylesheet" type="text/css" href="libs/jstree/themes/mixed/style.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
</head>

<body>
<script src="libs/jquery/jquery-3.1.1.min.js"></script>
<script src="libs/spectrum/spectrum.js"></script>
<script src="libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
<script src="libs/jquery-ui/jquery-ui.min.js"></script>
<script src="libs/three.js/build/three.min.js"></script>
<script src="libs/other/BinaryHeap.js"></script>
<script src="libs/tween/tween.min.js"></script>
<script src="libs/d3/d3.js"></script>
<script src="libs/proj4/proj4.js"></script>
<script src="libs/openlayers3/ol.js"></script>
<script src="libs/i18next/i18next.js"></script>
<script src="libs/jstree/jstree.js"></script>
<script src="libs/potree/potree.js"></script>
<script src="libs/plasio/js/laslaz.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script src="assets/03_POSES/cameras.js"></script>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/4.1.2/math.min.js"></script>

<!-- Bootstrap Layout -->
<nav class="navbar navbar-expand-lg navbar-light bg-light py-0" style="z-index:100; position: absolute; right: 0px;">
    <a class="navbar-brand" href="#">
        <!--<img src="img/logoOSU2.png"  height="50px" class="d-inline-block align-top">-->
    </a>

    <div class="d-flex justify-content-left nav-item">
        <span class="navbar-text"><h2> CIRCUITO DE 8"Ø DE SEPARADOR TRIFÁSICO TL-02 HACIA VÁLVULA LCV-202</h2></span>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <!--Create class ml-auto for the navbar items you want on the right.-->

            <!-- Annotation-->
            <li class="nav-item dropdown keep-open" id="annotat">
                    <a class="nav-link" href="#">
                    <span class="fa-stack fa-lg">
                        <i class="fa fa-square fa-stack-2x buttonbg"></i>
                        <i class="fa fa-commenting-o fa-stack-1x buttonfg"></i>
                    </span>
                </a>
            </li>

            <!-- Download-->

            <li class="nav-item dropdown keep-open">
                <a class="nav-link " href="#" role="button" data-toggle="dropdown" >
                    <span class="fa-stack fa-lg">
                        <i class="fa fa-square fa-stack-2x buttonbg"></i>
                        <i class="fa fa-download fa-stack-1x buttonfg"></i>
                        <i class="fa fa-sort-down fa-stack-1x buttonfg downchevron"></i>
                    </span>
                </a>
                <ul class="dropdown-menu dropdown-menu-right" >
                    <li id="downloadheader"><a class="dropdown-item navbar-text" href="#"> <strong>
                        <span class="fa-stack fa-lg">
                        <i class="fa fa-square fa-stack-2x buttonbg"></i>
                        <i class="fa fa-download fa-stack-1x buttonfg"></i>
                        </span>
                        Download Data</strong> </a></li>
                    <li><div class="dropdown-divider"></div></li>
                    <li><a class="dropdown-item navbar-text" href="assets/04_POINTCLOUD/foo.txt" download="foo_las.txt">
                        <i class="fa fa-cloud fa-fw fa-lg "></i>
                        Pointcloud</a>
                    </li>

                    <li><a class="dropdown-item navbar-text" href="assets/04_POINTCLOUD/foo.txt" download="foo_ortho.txt">
                        <i class="fa fa-image fa-fw fa-lg "></i>
                        Orthophoto</a>
                    </li>

                    <li><a class="dropdown-item navbar-text" href="assets/04_POINTCLOUD/foo.txt" download="foo_meta.txt">
                        <i class="fa fa-file fa-fw fa-lg "></i>
                        Metadata</a>
                    </li>
                </ul>
            </li>

            <!-- Info-->
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#infomodal">
                    <span class="fa-stack fa-lg">
                        <i class="fa fa-square fa-stack-2x buttonbg"></i>
                        <i class="fa fa-info fa-stack-1x buttonfg"></i>
                    </span>
                </a>
            </li>
            <!-- Help-->
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#helpmodal" onclick="$('#carouselExampleIndicators').carousel(0);">
                    <span class="fa-stack fa-lg">
                        <i class="fa fa-square fa-stack-2x buttonbg"></i>
                        <i class="fa fa-question fa-stack-1x buttonfg"></i>
                    </span>
                </a>
            </li>
        </ul>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
</nav>

document.title = "";
		viewer.setEDLEnabled(true);
		viewer.setBackground("gradient"); // ["skybox", "gradient", "black", "white"];
		viewer.setDescription(``);

	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area"></div>
		<div id="potree_sidebar_container"> </div>
	</div>

	<script type="x-shader/x-fragment" id="fs_interpolation">

    varying vec3 vColor;

    #extension GL_EXT_frag_depth : enable

    void main() {

        // make circular
        float a = pow(2.0*(gl_PointCoord.x - 0.5), 2.0);
        float b = pow(2.0*(gl_PointCoord.y - 0.5), 2.0);
        float c = 1.0 - (a + b);

        if(c < 0.0){
            discard;
        }


        gl_FragColor = vec4(vColor, 1.0);
        gl_FragDepthEXT = gl_FragCoord.z + 0.01*(1.0-pow(c, 2.0));
    }

</script>

<!-- Info Modal -->
<div class="modal fade" id="infomodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-success">
                <h4 class="modal-title">Information</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h5>Project</h5>
                <p>
                    This project demonstrates a method for visualizing SfM derived pointcloud and image data in a web browser.
                    Small details, which were not resolved by the SfM pointcloud, can still be visualized using the images.
                    <br>
                    <i class="fa fa-github hyp"></i> <a class="hyp" href="https://github.com/hokiespurs/potree-sfm">More information</a>.
                </p>
                <hr>
                <h5>Interface Attribution</h5>
                <ul>
                    <li>Pointcloud visualization and tools are built off of <a class="hyp" href="http://potree.org/">potree</a></li>
                    <li>The map is based on <a class="hyp" href="https://leafletjs.com/">leaflet</a></li>
                    <li>Basemap is provided by <a class="hyp" href="https://carto.com/location-data-services/basemaps/"> CartoDB</a></li>
                    <li>The layout utilizes <a class="hyp" href="https://getbootstrap.com/">Bootstrap</a></li>
                    <li>Coordinate conversions are handled with <a class="hyp" href="http://proj4js.org/">proj4js</a></li>
                    <li><a class="hyp" href="https://jquery.com/">jQuery</a> and <a class="hyp" href="https://jqueryui.com/">jQuery-ui</a> are used for DOM lookup and sliders</li>
                </ul>
                <hr>
                <h5>Data Attribution</h5>
                <p>
                    These data were collected as part of a 2017 Hurricane Irma and Maria Disaster Reconnaissance Survey in the US Virgin Islands by Oregon State University.
                    Funding for data acquisition was provided by the National Science Foundation through awards CMMI-1761461, CMMI-1661315.
                    Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the National Science Foundation
                </p>
                <hr>
                <img class="" src="img/logoNSF.png" height = "100px" alt="First slide">
                <img class="" src="img/logoOSU.png" height = "100px" alt="First slide">
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpmodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-info">
                <h4 class="modal-title">Help <a id="helpsubtitle">(1/12) - Layout</a></h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="helpmodalbody">
                <div id="myCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
                    <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel" data-interval="false">
                        <div class="carousel-inner" data-interval="false">
                            <!-- LAYOUT-->
                            <div class="carousel-item active" id="carousel_1">
                                <img class="d-block w-100" src="doc/howto/01_LAYOUT.png" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">The main sections of the project are the interactive map in the upper left, the toolbar across the top, and the main 3D scene. The main scene has both the pointcloud and image pyramids. </p>
                            </div>

                            <!-- IMAGE PYRAMIDS-->
                            <div class="carousel-item " id="carousel_2">
                                <img class="d-block w-100" src="doc/howto/02_IMAGEPYRAMIDS.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">"Image Pyramids" are placed in the scene to represent where an image was taken from. The image plane is placed at a position and orientation computed through SfM processing, such that it aligns with the pointcloud when viewed from the right position.</p>
                            </div>

                            <!-- SIMPLIFY LAYOUT-->
                            <div class="carousel-item " id="carousel_3">
                                <img class="d-block w-100" src="doc/howto/03_SIMPLIFY.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">The view can be simplified to turn off the map and images using the toggle buttons on the toolbar.</p>
                            </div>

                            <!-- NAVIGATION-->
                            <div class="carousel-item " id="carousel_4">
                                <img class="d-block w-100" src="doc/howto/04_NAV.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">Use the left mouse button to orbit around a point.  Use the scroll wheel to zoom.  Use the right mouse button to translate the view.  Double click a point to fly to it.</p>
                            </div>

                            <!-- NAVIGATION TO LOOK THROUGH-->
                            <div class="carousel-item " id="carousel_5">
                                <img class="d-block w-100" src="doc/howto/05_LOOKTHROUGH.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">"Look Through" mode is a view where the viewpoint is placed at the exact position an image was taken from.  The image plane is placed at a position and orientation such that it aligns with the pointcloud.
                                    This can be seen as holding a picture frame in front of a person.  The two ways to enter this mode are: 1) Click a desired image pyramid.  2) Click the Forward / Backward arrow on the toolbar.
                                    This will move the current view to align with either the selected image plane, or the previous/next image.</p>
                            </div>

                            <!-- NAVIGATION IN LOOK THROUGH MODE-->
                            <div class="carousel-item " id="carousel_6">
                                <img class="d-block w-100" src="doc/howto/06_NAVTHROUGH.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">Use the left mouse button to pan/tilt the camera.
                                Use the scroll wheel to zoom in and out (this is actually changing the field of view).
                                Use the left mouse button to translate the camera position, which will exit the "look-through" view.</p>
                            </div>

                            <!-- MAP LAYOUT-->
                            <div class="carousel-item " id="carousel_7">
                                <img class="d-block w-100" src="doc/howto/07_MAP.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">The interactive map box (which can be resized by dragging the lower right corner), contains a high resolution orthophoto of the scene overlaid on top of a simple basemap.
                                    The orange polygon represents the approximate footprint of the current view, while the cyan polygon represents the footprint of the current "look-through" image.
                                    There is a small, draggable dot which reprents the horizontal position of the current view.
                                </p>
                            </div>

                            <!-- MEASURE BUTTONS-->
                            <div class="carousel-item " id="carousel_8">
                                <img class="d-block w-100" src="doc/howto/08_MEASUREMENTS.png" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">The measurements toolbar enables 4 basic measurements on the pointcloud (Point, Distance, Height, and Angle.)  These measurements are displayed on the screen until the "Remove All" button is clicked.</p>
                            </div>

                            <!-- LOOK AT FUNCTIONALITY-->
                            <div class="carousel-item " id="carousel_11">
                                <img class="d-block w-100" src="doc/howto/11_LOOKAT.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px"> The "Look at" button can be used to filter the image planes by images that can see that point.
                                    Using the filter button enables and disables filtering by images.
                                    Using the "Visible Point" button turns the magenta dot off, but maintains the functionality.
                                    As you step through different "look through" views using the arrow keys, the camera will stay locked onto this point, and skip images which don't see the point.</p>
                            </div>

                            <!-- APPEARANCE TOOLS-->
                            <div class="carousel-item " id="carousel_9">
                                <img class="d-block w-100" src="doc/howto/09_APPEARANCE.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px">There are various appearance sliders and buttons which you can use to change the quality and color of the pointcloud. </p>
                            </div>

                            <!-- LOOK AT FUNCTIONALITY-->
                            <div class="carousel-item " id="carousel_12">
                                <img class="d-block w-100" src="doc/howto/12_OPACITY.gif" width = "100%" alt="First slide">
                                <hr>
                                <p style="height:100px"> When in "look through" mode, the opacity of the image can be changed with the appearance slider.</p>
                            </div>

                            <!-- DOWNLOAD BUTTONS-->
                            <div class="carousel-item " id="carousel_10">
                                <img class="d-block w-100" src="doc/howto/13_DOWNLOADS.png" alt="First slide">
                                <hr>
                                <p style="height:100px">The downloads dropdown can be used to download the pointcloud, orthophoto, and metadata. *Note: Rather that taxing the OSU research server with Gb of file transfers, small text files are used to demonstrate the functionality.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="prevBtn" type="button" class="btn btn-secondary" onclick="stepCarousel('prev')">Previous</button>
                <button id="nextBtn" type="button" class="btn btn-primary" onclick="stepCarousel('next')">Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Annotation Modal -->
<div class="modal fade" id="annotationmodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog" role="document">
        <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title">Annotation</h5>
                    </div>
                    <div class="modal-body">
                    <p>
                        <form>
                            <div class="form-group">
                                    <label>Titulo: </label> <input class="form-control" type="text" name="fname" id="annotationTitle"><br>
                                    <label>Descripcion: </label> <textarea class="form-control" type="text" name="lname" id="annotationDescription" style="height: 300px;"></textarea><br>
                            </div>
                        </form>
                    </p>
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="hideAnnotationModal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="annotationFormSubmit" type="submit">Save changes</button>
                    </div>
                </div>
        </div>
    </div>
</div>


<script src="js/loadpointcloud.js"></script>

<script>
    var cmap=Potree.Gradients["RAINBOW"];
    $('#lookAtFilter').hide();
    $('#toggleLookAtPtVisible').hide();

    function stepCarousel(stepdir){
        $('#carouselExampleIndicators').carousel(stepdir);
    }

    $('#carouselExampleIndicators').on('slide.bs.carousel', function (ev) {
        var id = ev.relatedTarget.id;
        var str='';
        switch (id) {
            case "carousel_1":
                str = '(1/12) - Layout';
                break;
            case "carousel_2":
                str = '(2/12) - Image Pyramids';
                break;
            case "carousel_3":
                str = '(3/12) - Simplifying the Layout';
                break;
            case "carousel_4":
                str = '(4/12) - Navigation';
                break;
            case "carousel_5":
                str = '(5/12) - Navigating to "Look-through" view';
                break;
            case "carousel_6":
                str = '(6/12) - Navigating in "Look-through" view';
                break;
            case "carousel_7":
                str = '(7/12) - Map Layout';
                break;
            case "carousel_8":
                str = '(8/12) - Measuring Tools';
                break;
            case "carousel_9":
                str = '(10/12) - Changing the Appearance';
                break;
            case "carousel_10":
                str = '(12/12) - Downloading Data';
                break;
            case "carousel_11":
                str = '(9/12) - "Look At" Tool';
                break;
            case "carousel_12":
                str = '(11/12) - "Look At" Image Opacity';
                break;
            default:
            //the id is none of the above 11/9/12/10 = 9/10/11/12
        }
        $('#helpsubtitle').text(str);
    })

    $('#toggleimage').on('click', function (e) {
        if(camsvisible){
            if (cameraplaneview) {
                imageplane.visible = false;
            }
            else {
                turnImagesOff();
            }
            camsvisible = false;
            $('#cameraicon').removeClass('buttonfgclicked');
        }
        else {
            if (cameraplaneview) {
                imageplane.visible = true;
            }
            else {
                turnImagesOn();
            }
            camsvisible = true;
            $('#cameraicon').addClass('buttonfgclicked');
        }
    });

    var annotat = $("annotat");
    
    $('#annotat').on('click', function(e) 
    {
        let measuringTool = new Potree.MeasuringTool(viewer);

        let dummyMeasure = measuringTool.startInsertion
        ({
                showDistances: false,
                showAngles: false,
                showCoordinates: true,
                showArea: false,
                closed: true,
                maxMarkers: 1,
                name: 'Point'
        });

        const stopDragging = e => {
                if (e.key === "Escape") {
                    window.viewer.inputHandler.drag = null;
                    dummyMeasure.removeMarker(dummyMeasure.points.length - 1);
                    window.viewer.scene.removeMeasurement(dummyMeasure);
                    document.removeEventListener('keyup', stopDragging);
                }
            }

            document.addEventListener('keyup', stopDragging);

            dummyMeasure.addEventListener('marker_dropped', (markerDroppedEvent) => {
                document.removeEventListener('keyup', stopDragging);

                const annotationFormButton = document.getElementById('annotationFormSubmit');
                const annotationTitle = document.getElementById('annotationTitle');
                const annotationDescription = document.getElementById('annotationDescription');
                const hideAnnotationModal = document.getElementById('hideAnnotationModal');
                const annotationForm = $("#annotationmodal");

                annotationForm.modal();

                const stopInsertion = e => {
                    if (e.key === "Escape" || e.type === 'click') {
                        window.viewer.scene.removeMeasurement(dummyMeasure);
                        annotationForm.modal();
                        document.removeEventListener('keyup', stopInsertion);
                        hideAnnotationModal.removeEventListener('click', stopInsertion);
                    }
                }
                
                hideAnnotationModal.addEventListener('click', stopInsertion);
                document.addEventListener('keyup', stopInsertion)
                
                function handleFormSubmit () {
                    if (!annotationTitle.value) {
                        window.viewer.scene.removeMeasurement(dummyMeasure);
                        return;
                    }
                
                    window.viewer.scene.addAnnotation(
                        markerDroppedEvent.measurement.points[0].position, 
                        {
                            title: annotationTitle.value,
                            description: annotationDescription.value || null,
                            cameraPosition: [window.viewer.scene.view.position.x, window.viewer.scene.view.position.y, window.viewer.scene.view.position.z],
                            cameraTarget: [window.viewer.scene.view.getPivot().x, window.viewer.scene.view.getPivot().y, window.viewer.scene.view.getPivot().z]
                        }    
                    );

                    window.viewer.scene.removeMeasurement(dummyMeasure);

                    let annotationInfo = {
                        type: '3dannotation',
                        title: annotationTitle.value,
                        data: JSON.stringify({
                            position: [markerDroppedEvent.measurement.points[0].position.x, markerDroppedEvent.measurement.points[0].position.y, markerDroppedEvent.measurement.points[0].position.z],
                            title: annotationTitle.value,
                            description: annotationDescription.value || null,
                            cameraPosition: [window.viewer.scene.view.position.x, window.viewer.scene.view.position.y, window.viewer.scene.view.position.z],
                            cameraTarget: [window.viewer.scene.view.getPivot().x, window.viewer.scene.view.getPivot().y, window.viewer.scene.view.getPivot().z]
                        })
                    };

                    fetch(annotationInfo)
                    .then(annotationResponse => {
                        if (!annotationResponse.status) {
                            return Promise.reject(annotationResponse.content);
                        }
                        const annotationCount = window.viewer.scene.annotations.children.length;
                        window.viewer.scene.annotations.children[annotationCount - 1].id = annotationResponse.content;
                    })
                    .catch(reason => {
                        // error
                    });

                    window.viewer.scene.removeMeasurement(dummyMeasure)
                    annotationFormButton.removeEventListener('click', handleFormSubmit);
                    annotationForm.modal();
                    document.removeEventListener('keyup', stopInsertion);
                };

                annotationFormButton.addEventListener('click', handleFormSubmit);
            });
    });

    $('#imgleft').on('click', function (e) {
        currentid--;
        if (currentid < 0) {
            currentid = ncams - 1;
        }
        var count=0;
        var flag = true;
        if (dofilterimages) {
            while (imageobj[currentid].isFiltered) {
                currentid--;
                count++;
                if (currentid < 0) {
                    currentid = ncams - 1;
                }
                if (count > ncams) {
                    flag = false;
                    break;
                }
            }
        }
        if (flag) {
            flyToCam(currentid);
        }
    });

    $('#imgright').on('click', function (e) {

        currentid++;
        if (currentid>(ncams-1)){currentid=0;}

        var count=0;
        var flag = true;
        if (dofilterimages) {
            while (imageobj[currentid].isFiltered) {
                currentid++;
                count++;
                if (currentid > (ncams - 1)) {
                    currentid = 0;
                }

                if (count > ncams) {
                    flag = false;
                    break;
                }
            }
        }
        if (flag) {
            flyToCam(currentid);
        }

    });

    $('#measPoint').on('click', measPoint);
    $('#measDistance').on('click', measDistance);
    $('#measHeight').on('click', measHeight);
    $('#measAngle').on('click', measAngle);
    $('#measClear').on('click', measClear);
    $('#measLookAt').on('click', measLookAt);
    $('#lookAtFilter').on('click', toggleFilterImages);
    $('#toggleLookAtPtVisible').on('click', toggleLookAtPtVisible);



    $('#togglemap').on('click', togglemap);

    $('#btntogglelighting').on('click', toggleEDL);
    $('#btntoggleHQ').on('click', toggleHQ);

    $('#btnRGB').on('click', colorbyRGB);
    $('#btnBoth').on('click', colorbyBoth);
    $('#btnElev').on('click', colorbyElev);

    $('#btnColormap1').on('click', changeColormap);
    $('#btnColormap2').on('click', changeColormap);
    $('#btnColormap3').on('click', changeColormap);
    $('#btnColormap4').on('click', changeColormap);
    $('#btnColormap5').on('click', changeColormap);
    $('#btnColormap6').on('click', changeColormap);
    $('#btnColormap7').on('click', changeColormap);


    function toggleLookAtPtVisible() {
        if (viewer.scene.measurements[lookAtPtNum].visible){
            viewer.scene.measurements[lookAtPtNum].visible = false;
            $('#lookatvisible').removeClass('buttonfgclicked');
        }
        else {
            viewer.scene.measurements[lookAtPtNum].visible = true;
            $('#lookatvisible').addClass('buttonfgclicked');
        }

    }

    function toggleFilterImages(){
        if (dofilterimages){
            dofilterimages = false;
            turnImagesOn();
            if (!camsvisible){
                turnImagesOff();
            }
            else {
                turnImagesOn();
                $('#cameraicon').addClass('buttonfgclicked');
            }
            $('#filterbtn').removeClass('buttonfgclicked');
        }
        else {
            dofilterimages = true;
            filterImages();
            $('#cameraicon').addClass('buttonfgclicked');

            if (cameraplaneview){
                if (!camsvisible){
                    turnImagesOff();
                }
                else {
                    turnImagesOff();
                    $('#cameraicon').addClass('buttonfgclicked');
                }
                $('#cameraicon').removeClass('buttonfgclicked');
            }
            $('#filterbtn').addClass('buttonfgclicked');
        }
    }
    function toggleEDL(){
        if (viewer.useEDL){
            viewer.useEDL = false;
            $('#btnlightbulb').removeClass('buttonfgclicked');
        }
        else {
            viewer.useEDL = true;
            $('#btnlightbulb').addClass('buttonfgclicked');

        }
    }

    function toggleHQ(){
        if (viewer.useHQ){
            viewer.useHQ = false;
            $('#btnHQ').removeClass('buttonfgclicked');
        }
        else {
            viewer.useHQ = true;
            $('#btnHQ').addClass('buttonfgclicked');
        }
    }

    function changeColormap(){
        switch(this.id){
            case "btnColormap1":
                cmap = Potree.Gradients["GRAYSCALE"];
                break;
            case "btnColormap2":
                cmap = Potree.Gradients["INFERNO"];
                break;
            case "btnColormap3":
                cmap = Potree.Gradients["PLASMA"];
                break;
            case "btnColormap4":
                cmap = Potree.Gradients["RAINBOW"];
                break;
            case "btnColormap5":
                cmap = Potree.Gradients["SPECTRAL"];
                break;
            case "btnColormap6":
                cmap = Potree.Gradients["VIRIDIS"];
                break;
            case "btnColormap7":
                cmap = Potree.Gradients["YELLOW_GREEN"];
                break;
        }
        viewer.scene.pointclouds[0].material.gradient = cmap;
    }

    function colorbyRGB(){
        viewer.scene.pointclouds.forEach( pc => pc.material.pointColorType = Potree.PointColorType.RGB );
        $( "#sliderColorBlend" ).slider('value',0);
        $( "#colorblendValue" ).val(0);
        viewer.scene.pointclouds[0].material.weightElevation = 0;
        viewer.scene.pointclouds[0].material.weightRGB = 1;
    }
    function colorbyElev(){
        viewer.scene.pointclouds.forEach( pc => pc.material.pointColorType = Potree.PointColorType.ELEVATION );
        $( "#sliderColorBlend" ).slider('value',100);
        $( "#colorblendValue" ).val(100);
        viewer.scene.pointclouds[0].material.weightElevation = 1;
        viewer.scene.pointclouds[0].material.weightRGB = 0;
    }
    function colorbyBoth() {
        viewer.scene.pointclouds.forEach(pc => pc.material.pointColorType = Potree.PointColorType.COMPOSITE);
        $( "#sliderColorBlend" ).slider('value',50);
        $( "#colorblendValue" ).val(50);
        viewer.scene.pointclouds[0].material.weightElevation = 50/100;
        viewer.scene.pointclouds[0].material.weightRGB = 50/100;

    }

    function togglemap(){
        if (mapshow){
            $('#mapcontainer').hide();
            mapshow = false;
            $('#mapbutton').removeClass('buttonfgclicked');
        }
        else {
            $('#mapcontainer').show();
            mapshow = true;
            $('#mapbutton').addClass('buttonfgclicked');
        }

    }
    $('#mapcontainer').on('click',triggermapresize);
    function triggermapresize(){
        mymap.invalidateSize();
    }

    $('.keep-open').on({
        "shown.bs.dropdown": function() { $(this).attr('closable', false); },
        "hide.bs.dropdown":  function() { return $(this).attr('closable') == 'true'; }
    });

    $('#measheader').on({
        "click": function() {
            $('.keep-open').attr('closable', true );
            $(this).parent().attr('closable', true );
        }
    });

    $('#appearanceheader').on({
        "click": function() {
            $('.keep-open').attr('closable', true );
            $(this).parent().attr('closable', true );
        }
    });

    $('#downloadheader').on({
        "click": function() {
            $('.keep-open').attr('closable', true );
            $(this).parent().attr('closable', true );
        }
    });


    $('.keep-open .nav-link').on({
        "click": function() {
            $('.keep-open').attr('closable', true );
            $(this).parent().attr('closable', true );
        }
    });

    var zlimits = [-0.8, 19.1];
    $( "#minval" ).val( 0 );
    $( "#maxval" ).val( 15 );

    $( function() {
        $( "#slider-range" ).slider({
            range: true,
            min: Math.floor(zlimits[0]*10)/10,
            max: Math.ceil(zlimits[1]*10)/10,
            values: [ Math.floor(zlimits[0]*10)/10, Math.ceil(zlimits[1]*10)/10 ],
            step: 0.1,
            slide: function( event, ui ) {
                $( "#minval" ).val( ui.values[ 0 ]);
                $( "#maxval" ).val( ui.values[ 1 ]);
                viewer.scene.pointclouds[0].material.elevationRange = [ui.values[ 0 ], ui.values[ 1 ]];
            }
        });
    } );
    $( function() {
        $( "#sliderColorBlend" ).slider({
            range: false,
            min: 0,
            max: 100,
            value: 0,
            step: 5,
            slide: function( event, ui ) {
                $( "#colorblendValue" ).val( ui.value);
                viewer.scene.pointclouds[0].material.weightElevation = ui.value/100;
                viewer.scene.pointclouds[0].material.weightRGB = 1-ui.value/100;
                viewer.scene.pointclouds.forEach(pc => pc.material.pointColorType = Potree.PointColorType.COMPOSITE);
            }
            }
        );
    } );
    $( function() {
        $( "#sliderImageOpacity" ).slider({
                range: false,
                min: 0,
                max: 100,
                value: 100,
            slide: function( event, ui ) {
                $( "#sliderImageOpacityValue" )
                    .val( ui.value.toString() + '%');
                imageplane.children[0].material.opacity = ui.value/100;
            }
            }
        );
    } );

    $( function() {
        $( "#sliderPointBudget" ).slider({
                range: false,
                min: 1000000,
                max: 10000000,
                value: 1000000,
                step: 500000,
            slide: function( event, ui ) {
                $( "#sliderPointBudgetValue" )
                    .val( (ui.value/1000000).toString() + 'M');
                viewer.setPointBudget(ui.value);
            }
            }
        );
    } );

    viewer.minNodeSize = 50;
    $( function() {
        $( "#sliderPointSize" ).slider({
                range: false,
                min: 0,
                max: 400,
                value: 50,
            slide: function( event, ui ) {
                $( "#sliderPointSizeValue" )
                    .val( ui.value);
                viewer.minNodeSize = ui.value;
            }
            }
        );
    } );

    // FUNCTION TO GET COLORMAPS TO MAKE IMAGE OF THEM
    function printColorMap(){
        var j=0;
        for(j=0;j<7;j++) {
            switch(j){
                case 0:
                    cmap = Potree.Gradients["GRAYSCALE"];
                    break;
                case 1:
                    cmap = Potree.Gradients["INFERNO"];
                    break;
                case 2:
                    cmap = Potree.Gradients["PLASMA"];
                    break;
                case 3:
                    cmap = Potree.Gradients["RAINBOW"];
                    break;
                case 4:
                    cmap = Potree.Gradients["SPECTRAL"];
                    break;
                case 5:
                    cmap = Potree.Gradients["VIRIDIS"];
                    break;
                case 6:
                    cmap = Potree.Gradients["YELLOW_GREEN"];
                    break;
            }

            var i;
            var strout = '';
            nelements = cmap.length;
            for (i = 0; i < nelements; i++) {
                strout = strout + '\n' + (cmap[i][0].toString() + ',' + cmap[i][1].r.toString() + ',' + cmap[i][1].g.toString() + ',' + cmap[i][1].b.toString());
            }
            console.log(strout);

        }
    }

</script>


</body>
</html>
